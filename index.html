<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>포켓몬 성격 테스트 | PMD Master</title>
    
    <link href="https://fonts.googleapis.com/css2?family=DungGeunMo&display=swap" rel="stylesheet">
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --window-bg: #1a202c;
            --border-green: #38f838;
            --wave-color: #38f838;
            --text-white: #ffffff;
            --bg-dark: #0a0e17; 
            --bg-grid: rgba(56, 248, 56, 0.05);
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; touch-action: manipulation; }
        
        body {
            font-family: 'DungGeunMo', monospace;
            margin: 0; padding: 0;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh;
            background-color: var(--bg-dark);
            background-image: linear-gradient(var(--bg-grid) 1px, transparent 1px),
                              linear-gradient(90deg, var(--bg-grid) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-white);
            overflow: hidden;
            user-select: none;
        }

        #game-container { width: 95%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; z-index: 10; padding: 10px; }

        .window {
            background: var(--window-bg);
            border: 4px solid var(--border-green);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(56, 248, 56, 0.2);
            padding: 20px;
            position: relative;
        }

        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 1000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
        }
        
        #intro-text { font-size: 1.3rem; line-height: 1.8; text-align: center; word-break: keep-all; color: #fff; max-width: 85%; min-height: 120px; }

        .next-btn {
            margin-top: 50px; width: 80%; max-width: 250px;
            background: transparent; color: #fff; border: 4px solid var(--border-green);
            padding: 15px; font-family: inherit; font-size: 1.2rem; cursor: pointer;
            border-radius: 10px; transition: 0.2s;
        }
        .next-btn:active { background: var(--border-green); color: #000; }

        .status-bar { display: flex; justify-content: space-between; color: var(--border-green); font-size: 14px; margin-bottom: 5px; }
        .progress-bar { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; }
        #progress-fill { height: 100%; background: var(--border-green); width: 0%; transition: width 0.3s; }

        #question-box { min-height: 140px; font-size: 1.15rem; line-height: 1.6; display: flex; align-items: center; justify-content: center; text-align: center; word-break: keep-all; }
        #answer-box { display: flex; flex-direction: column; gap: 10px; min-height: 150px; }

        .cursor::after { content: ' ▼'; animation: blink 0.8s infinite; color: var(--border-green); font-size: 0.9rem; }
        @keyframes blink { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

        .btn {
            background: rgba(255,255,255,0.05); border: 2px solid transparent; color: var(--text-white);
            font-family: inherit; font-size: 1.1rem; text-align: left;
            padding: 12px 15px 12px 35px; cursor: pointer; position: relative;
            border-radius: 5px; transition: 0.2s;
        }
        .btn:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--wave-color); }
        .btn::before { content: '▶'; position: absolute; left: 12px; }

        #wave-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, var(--wave-color) 0%, #000 95%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; text-align: center; color: #fff;
        }

        #wave-msg { font-size: 1.35rem; font-weight: bold; padding: 0 30px; line-height: 1.8; min-height: 150px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }

        .wave-circle {
            width: 140px; height: 140px; border: 4px solid var(--wave-color);
            border-radius: 50%; margin-top: 30px; position: relative;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            box-shadow: 0 0 20px var(--wave-color); cursor: pointer;
        }
        .wave-fill { position: absolute; width: 0%; height: 0%; background: var(--wave-color); border-radius: 50%; opacity: 0.7; transition: 0.1s linear; }

        .result-layout { display: flex; flex-direction: column; align-items: center; width: 100%; animation: fadeIn 0.8s; }
        .result-nature { font-size: 1.1rem; color: var(--wave-color); margin-bottom: 5px; }
        .result-pokemon { font-size: 1.8rem; margin-bottom: 10px; border-bottom: 2px solid #fff; padding-bottom: 5px; }
        .result-desc { font-size: 1rem; line-height: 1.7; margin-bottom: 20px; color: #cbd5e1; word-break: keep-all; max-width: 95%; text-align: center; }
        #pokemon-img { width: 180px; height: 180px; margin: 10px 0; object-fit: contain; filter: drop-shadow(0 0 15px var(--wave-color)); }

        .btn-retry { text-align: center; padding: 12px 15px; width: 100%; margin-top: 10px; position: relative; }
        .btn-retry::before { content: '▶'; position: static; margin-right: 8px; }
        .btn-share { text-align: center; padding: 12px 15px; width: 100%; margin-top: 8px; background: rgba(56, 248, 56, 0.2); border-color: var(--wave-color); }
        .btn-share::before { content: '▶'; position: static; margin-right: 8px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .anim-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .hidden { display: none !important; }
        #player { position: fixed; bottom: 0; right: 0; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="player"></div>

<div id="intro-layer">
    <div id="intro-text"></div>
    <button class="next-btn" onclick="nextIntro()">다음</button>
</div>

<div id="game-container" class="hidden">
    <div id="ui-header">
        <div class="status-bar">
            <span id="step-name">성격 진단</span>
            <span id="step-count">0 / 20</span>
        </div>
        <div class="progress-bar"><div id="progress-fill"></div></div>
    </div>
    <div id="question-box" class="window">
        <div id="text-display"></div>
    </div>
    <div id="answer-box" class="window"></div>
</div>

<div id="wave-layer" class="hidden">
    <div id="wave-msg"></div>
    <div class="wave-circle hidden" id="wave-trigger">
        <div class="wave-fill" id="wave-fill"></div>
        <span style="z-index:1; font-weight: bold; text-shadow: 1px 1px 2px #000;">PUSH</span>
    </div>
</div>

<script>
    // --- 성격별 핵심 특징 (관찰자 시점) ---
    const NATURE_TRAITS = {
        Hardy: "작은 일에 연연하지 않고 목표를 향해 달리는 너의 끈기",
        Docile: "싸움을 싫어하고 남을 먼저 배려하려는 너의 착한 마음씨",
        Brave: "핀치에 몰린 동료를 위해 기꺼이 나서는 너의 용기",
        Jolly: "어떤 슬픈 일도 웃으며 털어내는 너의 긍정적인 에너지",
        Impish: "분위기를 밝게 만들고 장난을 즐기는 너의 활동적인 모습",
        Naive: "순수하고 거짓말을 할 줄 모르는 너의 맑은 영혼",
        Bold: "어떤 상황에서도 당황하지 않는 너의 대담한 배짱",
        Timid: "조금은 신중하고 세심하게 주변을 살피는 너의 사려 깊음",
        Hasty: "마음먹은 일은 바로 실행에 옮기는 너의 놀라운 추진력",
        Sassy: "지기 싫어하고 자신감 있게 자기 의견을 말하는 너의 당당함",
        Quiet: "상황을 객관적으로 분석하고 판단하는 너의 냉철한 지혜",
        Relaxed: "남들이 뭐라 하든 여유를 잃지 않는 너의 마이페이스",
        Rash: "조금은 덤벙거려도 금방 기운을 차리는 너의 낙천적인 태도",
        Quirky: "틀에 얽매이지 않고 자유롭게 생각하는 너의 독특한 발상",
        Lonely: "겉으로는 강한 척하지만 사실은 따뜻한 정을 그리워하는 너의 마음",
        Calm: "곤란한 사람을 그냥 지나치지 못하는 너의 상냥한 배려"
    };

    const ALL_QUESTIONS = [
        { q: "휴일인데 아무도 놀아 주지 않는다... 그럼 당신은?", a: [{t: "여행을 떠난다", s: {Jolly: 4, Rash: 2}}, {t: "멍하게 있는다", s: {Relaxed: 4, Calm: 2}}, {t: "방구석에 박혀있는다", s: {Lonely: 4, Quiet: 2}}] },
        { q: "비밀을 무심코 누설해버린 적이 있는가?", a: [{t: "있다", s: {Rash: 4, Lonely: 4}}, {t: "없다", s: {Hardy: 2}}] },
        { q: "용돈 관리는 어떻게 하는가?", a: [{t: "꾸준히 모으고 있다", s: {Hardy: 4}}, {t: "금방 써버린다", s: {Quirky: 4, Hasty: 2}}, {t: "절반은 쓰고 전달은 모은다", s: {Calm: 2}}, {t: "받지 않는다...", s: {Lonely: 4}}] },
        { q: "매일 복근 운동 10회. 계속할 수 있을까?", a: [{t: "이 정도는 누워서 떡 먹기다", s: {Impish: 4, Sassy: 2}}, {t: "열심히 해 본다", s: {Hardy: 4}}, {t: "처음부터 할 생각이 없다", s: {Quirky: 4}}] },
        { q: "모르는 것은 모른다고 솔직하게 말할 수 있는가?", a: [{t: "말할 수 있다", s: {Docile: 4, Bold: 2}}, {t: "잘 말하지 못한다", s: {Timid: 4, Lonely: 2}}] },
        { q: "장래를 점쳐 보니 결과가 매우 나빴다. 너라면?", a: [{t: "매우 불안해진다", s: {Docile: 4, Timid: 2}}, {t: "잊어버린다", s: {Jolly: 4, Relaxed: 2, Bold: 2}}] },
        { q: "굉장히 도움이 되는 정보를 얻었다! 너라면?", a: [{t: "비밀로 간직한다", s: {Bold: 4, Timid: 2}}, {t: "친구에게 가르쳐 준다", s: {Docile: 4, Rash: 4}}, {t: "다른 정보를 흘린다", s: {Impish: 4}}] },
        { q: "풍선을 얼마만큼 불 수 있는가?", a: [{t: "터지기 직전까지 팽팽하게", s: {Brave: 4, Impish: 4}}, {t: "적당히 그만둔다", s: {Quiet: 2}}, {t: "무서워서 불지 못한다", s: {Timid: 4, Docile: 2}}] },
        { q: "모두와 다른 의견이라도 확실히 말할 수 있는가?", a: [{t: "예", s: {Brave: 4, Bold: 2}}, {t: "아니오", s: {Lonely: 4, Timid: 2}}, {t: "상황에 따라 다르다", s: {Calm: 2, Quirky: 2}}] },
        { q: "기쁜 일이 있으면 무심코 춤을 추는가?", a: [{t: "예", s: {Jolly: 4, Lonely: 2}}, {t: "아니오", s: {Calm: 2}}] },
        { q: "모르는 사람에게도 쉽게 말을 거는가?", a: [{t: "예", s: {Jolly: 4}}, {t: "아니오", s: {Bold: 4, Timid: 2, Docile: 2}}] },
        { q: "자주 다치는 타입인가?", a: [{t: "예", s: {Impish: 4, Rash: 4}}, {t: "아니오", s: {Calm: 2}}] },
        { q: "정글 탐험을 하고 싶은가?", a: [{t: "예", s: {Impish: 4, Naive: 2}}, {t: "아니오", s: {Quirky: 4, Timid: 2}}] },
        { q: "지하실에서 비밀 계단을 발견했다! 너는...", a: [{t: "내려가 본다", s: {Impish: 4, Brave: 4, Rash: 2, Hasty: 2}}, {t: "일단 내버려 둔다", s: {Timid: 2}}] },
        { q: "친구가 심하게 자빠졌다! 너는?", a: [{t: "바로 도와준다", s: {Brave: 4, Lonely: 2}}, {t: "나도 모르게 웃는다", s: {Naive: 4, Impish: 4, Rash: 2}}] }
    ];

    const KOREAN_TYPE_MAP = { Hardy: "노력하는", Docile: "온순한", Brave: "용감한", Jolly: "명랑한", Impish: "장난꾸러기", Naive: "천진난만한", Bold: "대담한", Timid: "겁쟁이", Hasty: "성급한", Sassy: "건방진", Quiet: "냉정한", Relaxed: "무사태평", Rash: "덜렁거리는", Quirky: "변덕스러운", Lonely: "외로움타는", Calm: "차분한" };
    const POKEMON_MAP = { male: { Hardy: "아차모", Docile: "파이리", Brave: "피카츄", Jolly: "리아코", Impish: "팽도리", Naive: "불꽃숭이", Bold: "모부기", Timid: "브케인", Hasty: "에나비", Sassy: "냐옹", Quiet: "나무지기", Relaxed: "먹고자", Rash: "물짱이", Quirky: "꼬부기", Lonely: "이상해씨", Calm: "치코리타" }, female: { Hardy: "나무지기", Docile: "이상해씨", Brave: "파이리", Jolly: "먹고자", Impish: "불꽃숭이", Naive: "에나비", Bold: "꼬부기", Timid: "모부기", Hasty: "피카츄", Sassy: "리아코", Quiet: "치코리타", Relaxed: "식스테일", Rash: "아차모", Quirky: "팽도리", Lonely: "물짱이", Calm: "브케인" } };
    const ID_MAP = { "아차모": 255, "파이리": 4, "피카츄": 25, "리아코": 158, "팽도리": 393, "불꽃숭이": 390, "모부기": 387, "브케인": 155, "에나비": 300, "냐옹": 52, "나무지기": 252, "먹고자": 446, "물짱이": 258, "꼬부기": 7, "이상해씨": 1, "치코리타": 152, "식스테일": 37 };
    const WAVE_COLORS = { Hardy: { color: "#ff4d4d", name: "정열적인 레드" }, Brave: { color: "#ff4d4d", name: "정열적인 레드" }, Rash: { color: "#ff4d4d", name: "정열적인 레드" }, Jolly: { color: "#ff80df", name: "귀여운 핑크" }, Naive: { color: "#ff80df", name: "귀여운 핑크" }, Relaxed: { color: "#33ccff", name: "맑은 스카이블루" }, Quiet: { color: "#33ccff", name: "맑은 스카이블루" }, Calm: { color: "#3366ff", name: "깊은 로열블루" }, Timid: { color: "#ffa31a", name: "따뜻한 오렌지" }, Hasty: { color: "#ffa31a", name: "따뜻한 오렌지" }, Sassy: { color: "#cc66ff", name: "신비로운 퍼플" }, Quirky: { color: "#cc66ff", name: "신비로운 퍼플" }, Bold: { color: "#ffff33", name: "눈부신 골드" }, Impish: { color: "#ffff33", name: "눈부신 골드" }, Docile: { color: "#38f838", name: "청명한 에메랄드" }, Lonely: { color: "#38f838", name: "청명한 에메랄드" } };

    let typingTimer = null, isTyping = false, introIdx = 0, currentIdx = 0, scores = {}, testPool = [], userGender = '', finalNature = "", player = null;
    let userChoices = []; // 사용자가 선택한 답변을 저장

    function onYouTubeIframeAPIReady() { player = new YT.Player('player', { videoId: 'ehI75lWfXhw', playerVars: { 'autoplay': 0, 'loop': 1, 'playlist': 'ehI75lWfXhw', 'controls': 0, 'disablekb': 1, 'playsinline': 1 }, events: { 'onReady': (e) => e.target.setVolume(30) } }); }

    function typeWriter(text, elementId, callback) {
        if (isTyping) { clearInterval(typingTimer); isTyping = false; }
        isTyping = true;
        const el = document.getElementById(elementId);
        el.innerText = ""; el.classList.remove('cursor');
        let i = 0;
        typingTimer = setInterval(() => {
            if (i < text.length) { el.append(text.charAt(i)); i++; }
            else { clearInterval(typingTimer); isTyping = false; el.classList.add('cursor'); if (callback) callback(); }
        }, 30);
    }

    function nextIntro() {
        if (isTyping) return;
        if (introIdx === 0 && player && player.playVideo) player.playVideo();
        if (introIdx < INTRO_TEXTS.length) { typeWriter(INTRO_TEXTS[introIdx], "intro-text"); introIdx++; }
        else { document.getElementById("intro-layer").classList.add("hidden"); document.getElementById("game-container").classList.remove("hidden"); askGender(); }
    }

    function askGender() {
        document.getElementById("answer-box").innerHTML = "";
        typeWriter("당신은 남자 아이인가요? 여자 아이인가요?", "text-display", () => {
            document.getElementById("answer-box").innerHTML = `
                <button class="btn" onclick="setGender('male')">남자 아이</button>
                <button class="btn" onclick="setGender('female')">여자 아이</button>
            `;
        });
    }

    function setGender(gender) {
        userGender = gender; currentIdx = 0; userChoices = [];
        Object.keys(KOREAN_TYPE_MAP).forEach(k => scores[k] = 0);
        testPool = [...ALL_QUESTIONS].sort(() => Math.random() - 0.5).slice(0, 20);
        render();
    }

    function render() {
        if (currentIdx >= testPool.length) { calculateResult(); startWaveScan(); return; }
        const data = testPool[currentIdx];
        document.getElementById("answer-box").innerHTML = "";
        document.getElementById("step-count").innerText = `${currentIdx + 1} / 20`;
        document.getElementById("progress-fill").style.width = `${((currentIdx + 1) / 20) * 100}%`;
        typeWriter(data.q, "text-display", () => {
            data.a.forEach(ans => {
                const btn = document.createElement("button");
                btn.className = "btn"; btn.innerText = ans.t;
                btn.onclick = () => { 
                    if (isTyping) return; 
                    for (let s in ans.s) scores[s] = (scores[s] || 0) + ans.s[s]; 
                    userChoices.push(ans.t); // 답변 저장
                    currentIdx++; render(); 
                };
                document.getElementById("answer-box").appendChild(btn);
            });
        });
    }

    function calculateResult() {
        const maxScore = Math.max(...Object.values(scores));
        const winners = Object.keys(scores).filter(k => scores[k] === maxScore);
        finalNature = winners[Math.floor(Math.random() * winners.length)];
        document.documentElement.style.setProperty('--wave-color', WAVE_COLORS[finalNature].color);
    }

    function startWaveScan() {
        document.getElementById("game-container").classList.add("hidden");
        const waveLayer = document.getElementById("wave-layer"), waveMsg = document.getElementById("wave-msg"), trigger = document.getElementById("wave-trigger"), fill = document.getElementById("wave-fill");
        waveLayer.classList.remove("hidden");
        const scanTexts = ["진단이 끝났습니다...", "이제 당신의 파동을 감지하겠습니다.", "화면의 원 위에 손가락을 대고...", "마음을 차분히 가라앉히세요."];
        let sIdx = 0;
        const showScanIntro = () => {
            if(sIdx < scanTexts.length) { waveMsg.innerText = scanTexts[sIdx]; sIdx++; setTimeout(showScanIntro, 1200); }
            else { waveMsg.innerHTML = "당신의 파동을 전달해 주세요...<br>(원을 꾹 누르세요)"; trigger.classList.remove("hidden"); trigger.classList.add("anim-pulse"); setupWaveEvent(); }
        };
        showScanIntro();

        function setupWaveEvent() {
            let pressTimer = null, progress = 0;
            const onStart = (e) => {
                if (e.cancelable) e.preventDefault(); if (pressTimer) return;
                pressTimer = setInterval(() => {
                    progress += 2.5; fill.style.width = progress + "%"; fill.style.height = progress + "%";
                    if (navigator.vibrate) navigator.vibrate(10);
                    if (progress >= 100) { clearInterval(pressTimer); completeScan(); }
                }, 35);
            };
            const onEnd = () => { clearInterval(pressTimer); pressTimer = null; progress = 0; fill.style.width = "0%"; fill.style.height = "0%"; };
            trigger.onpointerdown = onStart; window.onpointerup = onEnd; window.onpointercancel = onEnd;
            function completeScan() {
                trigger.onpointerdown = null; trigger.classList.remove("anim-pulse");
                waveMsg.innerHTML = `<span style="color:var(--wave-color)">파동을 수신했습니다!</span><br>당신의 파동은 ${WAVE_COLORS[finalNature].name}입니다.`;
                setTimeout(() => { waveLayer.classList.add("hidden"); document.getElementById("game-container").classList.remove("hidden"); showResult(); }, 2000);
            }
        }
    }

    function showResult() {
        document.getElementById("ui-header").classList.add("hidden");
        const natureName = KOREAN_TYPE_MAP[finalNature], resultName = POKEMON_MAP[userGender][finalNature], pokeId = ID_MAP[resultName];
        document.getElementById("answer-box").innerHTML = "";
        
        // 랜덤하게 사용자가 선택한 답변 3개를 골라 문장을 구성
        const sampledChoices = [...userChoices].sort(() => 0.5 - Math.random()).slice(0, 3);
        const choiceText = `아까 질문에서 '${sampledChoices[0]}'거나, '${sampledChoices[1]}'는 쪽을 택하더구나.`;

        typeWriter(`...너의 선택들을 곰곰이 지켜보았단다.`, "text-display", () => {
            setTimeout(() => {
                document.getElementById("question-box").innerHTML = `
                    <div class="result-layout">
                        <div class="result-desc">
                            너는 아까 질문에서<br>'<span style="color:var(--wave-color)">${sampledChoices[0]}</span>'거나, 
                            '<span style="color:var(--wave-color)">${sampledChoices[1]}</span>'는 쪽을 택하더구나.<br><br>
                            그걸 보니 너는 아무래도...<br>[${natureName}] 성격인 거 같아.<br><br>
                            ${NATURE_TRAITS[finalNature]}이(가)<br>대답 속에 고스란히 담겨있어.
                        </div>
                        <div class="result-nature" style="color:var(--wave-color); margin-top:10px;">그런 [${natureName}] 성격인 너는...</div>
                        <div class="result-pokemon">${resultName}!</div>
                        <img id="pokemon-img" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${pokeId}.png">
                        <button class="btn btn-retry" onclick="location.reload()">다시 하기</button>
                        <button class="btn btn-share" onclick="copyResult('${natureName}', '${resultName}')">결과 복사하기</button>
                    </div>`;
            }, 1000);
        });
    }

    function copyResult(nature, poke) {
        const text = `[포켓몬 성격 테스트 결과]\n나의 성격: ${nature}\n나와 닮은 포켓몬: ${poke}\n지금 테스트 해보기: ${window.location.href}`;
        navigator.clipboard.writeText(text).then(() => alert("결과가 클립보드에 복사되었습니다!"));
    }

    window.onload = () => typeWriter("... (아래 버튼을 눌러 시작하세요)", "intro-text");
</script>
</body>
</html>
